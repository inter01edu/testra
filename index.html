<script>
  // --- Simple copy HTML (signature only) ---
  function makeAbsoluteUrls(html) {
    const doc = new DOMParser().parseFromString(html, "text/html");

    // Rend les src/href absolus
    doc.querySelectorAll("[src]").forEach(el => {
      const v = el.getAttribute("src");
      if (!v || v.startsWith("data:") || v.startsWith("http://") || v.startsWith("https://")) return;
      el.setAttribute("src", new URL(v, window.location.href).href);
    });

    doc.querySelectorAll("a[href]").forEach(el => {
      const v = el.getAttribute("href");
      if (!v || v.startsWith("#") || v.startsWith("mailto:") || v.startsWith("tel:") || v.startsWith("http://") || v.startsWith("https://")) return;
      el.setAttribute("href", new URL(v, window.location.href).href);
    });

    return doc.body.innerHTML;
  }

  async function copyHtml(html) {
    const plain = html.replace(/<[^>]*>/g, " ").replace(/\s+/g, " ").trim();

    // Clipboard riche (HTML)
    if (navigator.clipboard && window.ClipboardItem) {
      await navigator.clipboard.write([
        new ClipboardItem({
          "text/html": new Blob([html], { type: "text/html" }),
          "text/plain": new Blob([plain], { type: "text/plain" })
        })
      ]);
      return true;
    }

    // Fallback texte
    const ta = document.createElement("textarea");
    ta.value = plain;
    ta.style.position = "fixed";
    ta.style.left = "-9999px";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    return false;
  }

  function addCopyButtons() {
    // On cherche tous les liens üîó (ancre contenant ce caract√®re)
    const linkIcons = Array.from(document.querySelectorAll("a")).filter(a => a.textContent.trim() === "üîó");

    linkIcons.forEach(a => {
      // √âvite double ajout
      if (a.closest(".signature-header")?.parentElement?.querySelector(".copy-signature-btn")) return;

      // On part du principe que la signature est dans le m√™me "bloc" (container)
      const container = a.closest(".signature-container") || a.parentElement?.parentElement;
      if (!container) return;

      // On prend le premier <table> de signature dans ce container (c'est g√©n√©ralement la signature)
      const signatureTable = container.querySelector("table");
      if (!signatureTable) return;

      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "copy-signature-btn";
      btn.textContent = "Copy signature";

      // On place le bouton "sous le üîó" : sous le header si possible
      let actions = container.querySelector(".signature-actions");
      if (!actions) {
        actions = document.createElement("div");
        actions.className = "signature-actions";
        const header = container.querySelector(".signature-header") || a.parentElement;
        header.insertAdjacentElement("afterend", actions);
      }

      actions.appendChild(btn);

      btn.addEventListener("click", async () => {
        try {
          btn.disabled = true;
          const prev = btn.textContent;
          btn.textContent = "Copying...";

          // Copie uniquement la signature (table)
          const html = makeAbsoluteUrls(signatureTable.outerHTML);
          await copyHtml(html);

          btn.textContent = "Copied ‚úì";
          setTimeout(() => {
            btn.textContent = prev;
            btn.disabled = false;
          }, 900);
        } catch (e) {
          btn.textContent = "Error";
          btn.disabled = false;
        }
      });
    });
  }

  // Lance apr√®s que la liste soit rendue (au besoin, re-scan apr√®s un petit d√©lai)
  addCopyButtons();
  setTimeout(addCopyButtons, 300);
</script>

